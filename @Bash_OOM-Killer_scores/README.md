# OOM killer

Ядро Linux дает оценку (oom_score) каждому запущенному процессу - **очки негодности** (badness). Максимальная оценка составляет 1000.  

Как вычисляются очки негодности? За основу берется процент физической памяти используемый процессом и умножается на 10, таким образом получаем базовое значение. Т.о., 1000 очков - это 100% использования памяти. Затем к данному значению начинают применяться различные модификаторы:  
- Прибавляется половина очков всех дочерних процессов, имеющих собственную виртуальную память.
- Если приоритет процесса больше нуля очки умножаются на два. Приоритет может иметь значение от -20 (наивысший приоритет) до 20 (самый низкий).
- Очки делятся на коэффициент, связанный с процессорным временем, чем более активен процесс и чем больше процессорного времени он использует, тем больше будет этот коэффициент.
- Очки делятся на коэффициент, связанный с временем жизни процесса, чем больше времени прошло с момента запуска, тем выше будет это значение.
- Для процессов, запущенных от имени root, обслуживающих систему или процессов ввода-вывода очки делятся на 4.
- Для процесса, при выделении памяти которому произошла ошибка out of memory и процессам имеющим с ним общую память, очки делятся на 8.
- Очки умножаются на 2^oom_adj, где oom_adj - специальный коэффициент, имеющий значения от -17 до 15, при -17 процесс никогда не будет убить OOM Killer.

**OOM Killer убьет самый "толстый" процесс, который наименее активен в системе и имеет самое короткое время жизни**. В системах виртуализации это будет неактивная виртуалка с наибольшим выделением памяти. Поэтому если у вас регулярно выключается одна из второстепенных машин - проверьте ситуацию с памятью, скорее всего это работа OOM Killer.  

---

Как узнать количество очков, присвоенных процессу?  
`cat /proc/{PID}/oom_score`  

---

Можно вручную настроить параметр `/proc/${pid}/oom_score_adj`. Окончательное значение `oom_score` будет добавлено к этому скорректированному значению. Если выставить в параметр `oom_score_adj` число -1000, это эквивалентно отключению OOM-убийств для процесса.
```bash
sudo echo -1000 > /proc/{PID}/oom_score_adj
# or
echo -17 > /proc/{PID}/oom_adj
```

---
 
Все это имеет один большой недостаток: применить коэффициент oom_adj мы можем только к запущенному процессу и по факту это ручная работа. Не следует применять эти методы на практике, кроме, разве что диагностики и отладки.  
В современных системах для управления службами используется **systemd**, который дает нам в руки простые и эффективные инструменты для управления очками негодности. Для этого в секцию `[Service]` юнита службы добавьте опцию:  
```bash
[Service]
...
 OOMScoreAdjust=-500
...
```

Значение `OOMScoreAdjust` показывает насколько следует изменить количество очков процесса относительно рассчитанного количества, в нашем примере мы уменьшили его на 500. Таким образом мы можем защитить важные службы вашей системы от убийства со стороны OOM Killer, но не стоит злоупотреблять этой опцией, в критической ситуации будет лучше, если OOM Killer убьет даже важный процесс, но сохранит вам доступ к системе, нежели вы окажетесь в ситуации с полным исчерпанием физической памяти и недоступности или перезагрузки вашего сервера.  
